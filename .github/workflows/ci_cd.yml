name: Flutter iOS CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  FLUTTER_VERSION: '3.38.0'

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    steps:
      # 1. 获取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Flutter 环境
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # 2.1 检查Flutter环境
      - name: Verify Flutter
        run: flutter doctor

      # 3. 安装项目依赖
      - name: Install dependencies
        run: flutter pub get

      # 3.1 安装iOS依赖（关键步骤！）
      - name: Install iOS dependencies
        run: |
          cd ios
          pod install --repo-update

      # 4. 检查项目结构
      - name: Check project structure
        run: |
          echo "项目结构:"
          find . -name "*.xcodeproj" -o -name "pubspec.yaml" | head -10

      # 5. 构建 iOS IPA 文件（添加详细日志）
      - name: Build IPA without code signing
        run: flutter build ipa --release --no-codesign --verbose

      # 6. 检查生成的文件
      - name: Check build results
        run: |
          echo "查找IPA文件:"
          find . -name "*.ipa" -type f 2>/dev/null || echo "未找到IPA文件"
          echo "构建目录内容:"
          ls -la build/ios/ || echo "无ios构建目录"

      # 7. 上传 IPA 文件（使用更灵活的路径）
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: |
            build/ios/ipa/*.ipa
            build/ios/*.ipa
            *.ipa
          if-no-files-found: warn  # 如果没有文件，警告而不是失败