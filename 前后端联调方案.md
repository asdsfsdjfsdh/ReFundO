# 前后端联调方案 - 退款请求模块和扫描记录模块

> 修改日期: 2026-02-05
> 目的: 以前端字段对齐后端 API，实现扫描记录和退款请求模块的联调

---

## 一、前后端映射关系

### 1.1 扫描记录模块

**前端模型**: `OrderModel`
**后端模型**: `Scan.java` / `ScanRecordsVO.java`

| 前端字段 | 后端字段 (ScanRecordsVO) | 类型转换 |
|---------|-------------------------|---------|
| `orderid` | `ScanId` | int |
| `orderNumber` | `ScanNumber` | String |
| `ProductId` | `ProductId` | String |
| `price` | `OriginalPrice` | Decimal |
| `refundAmount` | `Value` | Decimal |
| `refundpercent` | `RefundRatio` | Decimal |
| `OrderTime` | `ScanTime` | String |
| `isRefund` | `RefundStatus` (0->false, 1->true) | bool |
| `refundState` | (额外状态) | bool |
| `refundTime` | (新增) | String |
| `errorMessage` | (新增) | String |

### 1.2 退款请求模块

**前端模型**: `RefundModel`
**后端模型**: `RefundRequest.java`

| 前端字段 | 后端字段 | 类型转换 |
|---------|---------|---------|
| `recordId` | `RequestId` | int |
| `orderNumber` | `RequestNumber` | String |
| `orderId` | (从 `ScanIds` 解析) | int |
| `productId` | (从关联产品获取) | String |
| `refundMethod` | `PaymentMethod` | int |
| `account` | `PaymentNumber` | String |
| `phone` | (从用户数据) | String |
| `userId` | `UserId` | int |
| `nickName` | (从用户数据) | String |
| `email` | (从用户数据) | String |
| `refundAmount` | `Amount` | Decimal |
| `timestamp` | `CreateTime` | String |
| `refundState` | `RequestStatus` | enum |
| `remittanceReceipt` | (从 RefundTransactions 表) | String? |
| `scanIds` | `ScanIds` | String? (新增) |
| `voucherUrl` | `VoucherUrl` | String? (新增) |
| `rejectReason` | `RejectReason` | String? (新增) |

---

## 二、API 路径变更

### 2.1 扫描记录相关 API

| 功能 | 前端原路径 | 后端新路径 | 请求方法 |
|-----|-----------|-----------|---------|
| 获取扫描记录列表 | `/api/orders/init` | `/api/scan/records` | GET |
| 获取扫描记录总数 | `/api/orders/count` | `/api/scan/records` (从响应获取 total) | GET |
| 插入扫描记录 | `/api/orders/insert` | `/api/scan/insert` | POST |
| 检查退款条件 | `/api/orders/check` | `/api/refund-request/calculate-amount` | GET |

### 2.2 退款请求相关 API

| 功能 | 前端原路径 | 后端新路径 | 请求方法 |
|-----|-----------|-----------|---------|
| 创建退款请求 | `/api/refund/insert` | `/api/refund-request` | POST |
| 获取退款列表 | `/api/refund/get` | `/api/refund-request/list` | GET |
| 获取所有退款 | `/api/refund/getAll` | `/api/refund-request/list` | GET |
| 获取退款详情 | - | `/api/refund-request/{id}` | GET |

---

## 三、后端 API 详细说明

### 3.1 GET /api/scan/records - 分页获取扫描记录

**请求参数 (URL Query)**:
```
pageNum: Integer  // 页码，默认 1
pageSize: Integer // 每页大小，默认 10
orderBy: String   // 排序字段: "create_time" 或 "amount"
orderDirection: String // 排序方向: "desc" 或 "asc"
```

**响应结构**:
```json
{
  "Code": 1,
  "Data": {
    "records": [
      {
        "ScanId": 1,
        "ScanNumber": "SN202501010001",
        "UserId": 100,
        "ProductId": 1001,
        "ScanTime": "2025-01-01T10:30:00",
        "RefundRatio": 0.5,
        "Value": 5000.00,
        "OriginalPrice": 10000.00
      }
    ],
    "total": 100,
    "pageNum": 1,
    "pageSize": 10,
    "pages": 10
  },
  "Message": null
}
```

### 3.2 POST /api/scan/insert - 新增扫描记录

**请求参数 (JSON Body)**:
```json
{
  "ProductId": "1001",
  "RefundRatio": 0.5,
  "Hash": "abc123def456",
  "Value": 5000.00,
  "OriginalPrice": 10000.00
}
```

**响应结构**:
```json
{
  "Code": 1,
  "Data": null,
  "Message": null
}
```

### 3.3 GET /api/refund-request/calculate-amount - 计算退款金额

**请求参数 (URL Query)**:
```
scanIds: String  // 逗号分隔的 scanId，如 "1,2,3"
```

**响应结构**:
```json
{
  "Code": 1,
  "Data": 15000.00,
  "Message": null
}
```

### 3.4 POST /api/refund-request - 创建退款请求

**请求参数 (JSON Body)**:
```json
{
  "scanIds": "1,2,3",
  "voucherUrl": "https://example.com/voucher.jpg",
  "paymentMethod": 1,
  "paymentNumber": "6222021234567890"
}
```

**响应结构**:
```json
{
  "Code": 1,
  "Data": null,
  "Message": null
}
```

### 3.5 GET /api/refund-request/list - 分页获取退款请求列表

**请求参数 (URL Query)**:
```
pageNum: Integer  // 页码，默认 1
pageSize: Integer // 每页大小，默认 10
orderBy: String   // 排序字段: "create_time" 或 "amount"
orderDirection: String // 排序方向: "desc" 或 "asc"
```

**响应结构**:
```json
{
  "Code": 1,
  "Data": {
    "records": [
      {
        "RequestId": 1,
        "RequestNumber": "RR202501010001",
        "UserId": 100,
        "ScanIds": "1,2,3",
        "Amount": 15000.00,
        "VoucherUrl": "https://example.com/voucher.jpg",
        "RequestStatus": 0,
        "RejectReason": null,
        "PaymentMethod": 1,
        "PaymentNumber": "6222021234567890",
        "CreateTime": "2025-01-01T10:30:00",
        "UpdateTime": "2025-01-01T10:30:00"
      }
    ],
    "total": 50,
    "pageNum": 1,
    "pageSize": 10,
    "pages": 5
  },
  "Message": null
}
```

**RequestStatus 状态码**:
- `0` - 待审核
- `1` - 已批准
- `2` - 已拒绝
- `3` - 处理中
- `4` - 已完成

---

## 四、前端代码修改

### 4.1 修改 `lib/data/models/order_model.dart`

```dart
import 'package:decimal/decimal.dart';

class OrderModel {
  final int orderid;
  final String orderNumber;
  final String ProductId;
  final Decimal price;
  final Decimal refundAmount;
  final Decimal refundpercent;
  final String OrderTime;
  final bool isRefund;
  final bool refundState;
  final String refundTime;
  final String errorMessage;

  String get orderTime => OrderTime;

  OrderModel({
    required this.orderid,
    required this.orderNumber,
    required this.ProductId,
    required this.price,
    required this.refundAmount,
    required this.refundpercent,
    required this.OrderTime,
    this.isRefund = false,
    this.refundState = false,
    this.refundTime = '',
    this.errorMessage = '',
  });

  Map<String, dynamic> toJson() => {
    'scanId': orderid,
    'productId': ProductId,
    'originalPrice': price.toString(),
    'refundAmount': refundAmount.toString(),
    'refundPercent': refundpercent.toDouble(),
  };

  factory OrderModel.fromJson(Map<String, dynamic> json) {
    // 辅助函数（仿照 UserModel）
    int getInt(List<String> keys) {
      for (String key in keys) {
        final value = json[key];
        if (value != null) {
          if (value is int) return value;
          if (value is double) return value.toInt();
          if (value is String) return int.tryParse(value) ?? 0;
        }
      }
      return 0;
    }

    String getString(List<String> keys) {
      for (String key in keys) {
        final value = json[key];
        if (value != null && value.toString().isNotEmpty) {
          return value.toString();
        }
      }
      return '';
    }

    Decimal getDecimal(List<String> keys) {
      for (String key in keys) {
        final value = json[key];
        if (value != null) {
          try {
            return Decimal.parse(value.toString());
          } catch (e) {
            return Decimal.zero;
          }
        }
      }
      return Decimal.zero;
    }

    double getDouble(List<String> keys) {
      for (String key in keys) {
        final value = json[key];
        if (value != null) {
          if (value is double) return value;
          if (value is int) return value.toDouble();
          if (value is String) return double.tryParse(value) ?? 0.0;
        }
      }
      return 0.0;
    }

    int refundStatus = getInt(['refundStatus', 'RefundStatus', 'isRefund']);
    bool isRefundValue = refundStatus == 1;

    return OrderModel(
      orderid: getInt(['scanId', 'ScanId', 'orderid']),
      orderNumber: getString(['scanNumber', 'ScanNumber', 'orderNumber']),
      ProductId: getString(['productId', 'ProductId']),
      price: getDecimal(['originalPrice', 'OriginalPrice', 'price']),
      refundAmount: getDecimal(['value', 'Value', 'refundAmount']),
      refundpercent: Decimal.parse(getDouble(['refundRatio', 'RefundRatio']).toString()),
      OrderTime: getString(['scanTime', 'ScanTime', 'createTime']),
      isRefund: isRefundValue,
      refundState: json['refundState'] == true,
      refundTime: getString(['refundTime', 'updateTime']),
      errorMessage: getString(['errorMessage', 'message']),
    );
  }

  @override
  String toString() {
    return 'OrderModel{orderid: $orderid, orderNumber: $orderNumber, isRefund: $isRefund}';
  }
}
```

### 4.2 修改 `lib/data/models/refund_model.dart`

```dart
import 'package:decimal/decimal.dart';
import 'package:flutter/cupertino.dart';
import 'package:refundo/l10n/app_localizations.dart';

enum RefundStates {
  pending,      // 0 - 待审核
  approved,     // 1 - 已批准
  rejected,     // 2 - 已拒绝
  processing,   // 3 - 处理中
  completed,    // 4 - 已完成
}

class RefundModel {
  final int recordId;
  final String orderNumber;
  final int orderId;
  final String productId;
  final int refundMethod;
  final String account;
  final String phone;
  final int userId;
  final String nickName;
  final String email;
  final Decimal refundAmount;
  final String timestamp;
  RefundStates refundState;
  final String? remittanceReceipt;
  final String? scanIds;
  final String? voucherUrl;
  final String? rejectReason;

  RefundModel({
    required this.recordId,
    required this.orderNumber,
    required this.orderId,
    required this.productId,
    required this.refundMethod,
    required this.account,
    required this.phone,
    required this.userId,
    required this.nickName,
    required this.email,
    required this.refundAmount,
    required this.timestamp,
    required this.refundState,
    this.remittanceReceipt,
    this.scanIds,
    this.voucherUrl,
    this.rejectReason,
  });

  String get_refundMethod(BuildContext context) {
    if (refundMethod == 1) {
      return AppLocalizations.of(context)!.orange_money;
    } else if (refundMethod == 2) {
      return AppLocalizations.of(context)!.wave;
    } else {
      return AppLocalizations.of(context)!.phone_number_label;
    }
  }

  Map<String, dynamic> toJson() => {
    'requestId': recordId,
    'orderNumber': orderNumber,
    'refundMethod': refundMethod,
    'account': account,
    'phone': phone,
    'userId': userId,
    'nickName': nickName,
    'email': email,
    'refundAmount': refundAmount.toString(),
    'timestamp': timestamp,
    'refundState': refundState.index,
  };

  factory RefundModel.fromJson(Map<String, dynamic> json) {
    // 辅助函数
    int getInt(List<String> keys) {
      for (String key in keys) {
        final value = json[key];
        if (value != null) {
          if (value is int) return value;
          if (value is double) return value.toInt();
          if (value is String) return int.tryParse(value) ?? 0;
        }
      }
      return 0;
    }

    String getString(List<String> keys) {
      for (String key in keys) {
        final value = json[key];
        if (value != null && value.toString().isNotEmpty) {
          return value.toString();
        }
      }
      return '';
    }

    Decimal getDecimal(List<String> keys) {
      for (String key in keys) {
        final value = json[key];
        if (value != null) {
          try {
            return Decimal.parse(value.toString());
          } catch (e) {
            return Decimal.zero;
          }
        }
      }
      return Decimal.zero;
    }

    final requestStatus = getInt(['requestStatus', 'RequestStatus']);
    RefundStates state = _getStatusFromRequestStatus(requestStatus);

    final scanIdsStr = getString(['scanIds', 'ScanIds']);
    int parsedOrderId = 0;
    if (scanIdsStr.isNotEmpty) {
      final ids = scanIdsStr.split(',');
      if (ids.isNotEmpty) {
        parsedOrderId = int.tryParse(ids[0].trim()) ?? 0;
      }
    }

    return RefundModel(
      recordId: getInt(['requestId', 'RequestId']),
      orderNumber: getString(['requestNumber', 'RequestNumber']),
      orderId: parsedOrderId,
      productId: getString(['productId']),
      refundMethod: getInt(['paymentMethod', 'PaymentMethod']),
      account: getString(['paymentNumber', 'PaymentNumber']),
      phone: getString(['phoneNumber']),
      userId: getInt(['userId', 'UserId']),
      nickName: getString(['userName', 'username']),
      email: getString(['email']),
      refundAmount: getDecimal(['amount', 'Amount']),
      timestamp: getString(['createTime', 'CreateTime']),
      refundState: state,
      remittanceReceipt: getString(['remittanceReceipt']),
      scanIds: scanIdsStr.isNotEmpty ? scanIdsStr : null,
      voucherUrl: getString(['voucherUrl']),
      rejectReason: getString(['rejectReason']),
    );
  }

  static RefundStates _getStatusFromRequestStatus(int status) {
    switch (status) {
      case 0: return RefundStates.pending;
      case 1: return RefundStates.approved;
      case 2: return RefundStates.rejected;
      case 3: return RefundStates.processing;
      case 4: return RefundStates.completed;
      default: return RefundStates.pending;
    }
  }
}
```

### 4.3 修改 `lib/data/services/api_order_service.dart`

主要变更：
- `/api/orders/init` → `GET /api/scan/records`
- `/api/orders/count` → 从 `/api/scan/records` 响应中获取 `total`
- `/api/orders/insert` → `POST /api/scan/insert`
- `/api/orders/check` → `GET /api/refund-request/calculate-amount`
- `/api/refund/insert` → `POST /api/refund-request`

**请求参数示例**:

```dart
// 获取扫描记录列表
Response response = await dioProvider.dio.get(
  '/api/scan/records',
  queryParameters: {
    "pageNum": page,
    "pageSize": pageSize,
    "orderBy": "create_time",
    "orderDirection": "desc",
  },
);

// 插入扫描记录
Response response = await dioProvider.dio.post(
  '/api/scan/insert',
  data: {
    "productId": product.ProductId,
    "originalPrice": product.price.toString(),
    "refundRatio": product.RefundPercent,
    "hash": product.Hash,
    "value": product.RefundAmount.toString(),
  },
);

// 计算退款金额
Response response = await dioProvider.dio.get(
  '/api/refund-request/calculate-amount',
  queryParameters: {
    "scanIds": "1,2,3",
  },
);

// 创建退款请求
Response response = await dioProvider.dio.post(
  "/api/refund-request",
  data: {
    "scanIds": "1,2,3",
    "paymentMethod": refundType,
    "paymentNumber": refundAccount,
  },
);
```

### 4.4 修改 `lib/data/services/api_refund_service.dart`

主要变更：
- `/api/refund/get` → `GET /api/refund-request/list`
- `/api/refund/getAll` → `GET /api/refund-request/list`

**请求参数示例**:

```dart
// 获取退款列表
Response response = await dioProvider.dio.get(
  '/api/refund-request/list',
  queryParameters: {
    "pageNum": 1,
    "pageSize": 100,
    "orderBy": "create_time",
    "orderDirection": "desc",
  },
);

// 获取退款详情
Response response = await dioProvider.dio.get(
  '/api/refund-request/$requestId',
);
```

---

## 五、修改文件清单

| 文件路径 | 操作 | 说明 |
|---------|------|------|
| `lib/data/models/order_model.dart` | 修改 | 更新 `fromJson` 匹配后端 `ScanRecordsVO` |
| `lib/data/models/refund_model.dart` | 修改 | 更新 `fromJson` 匹配后端 `RefundRequest` |
| `lib/data/services/api_order_service.dart` | 修改 | 修正所有 API 路径和参数 |
| `lib/data/services/api_refund_service.dart` | 修改 | 修正所有 API 路径 |
| `lib/core/services/scan_history_service.dart` | 保留 | 本地存储服务不变 |
| `lib/data/models/Product_model.dart` | 保留 | 扫描输入模型不变 |

---

## 六、注意事项

1. **响应结构差异**: 后端返回 `{Code, Data, Message}` 格式，前端需要适配
2. **分页参数**: 后端使用 `pageNum`/`pageSize`，请求方法改为 GET
3. **状态码**: 后端 `Code = 1` 表示成功，`Code = 0` 表示失败
4. **金额精度**: 使用 `Decimal` 类型确保精度
5. **字段映射**: 使用辅助函数支持多种后端字段名（参考 `UserModel`）
